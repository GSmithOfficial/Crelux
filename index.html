<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submission Template Converter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --surface2:  #232733;
      --border:    #2e3345;
      --text:      #e2e4eb;
      --text-dim:  #8b8fa3;
      --accent:    #5b9cf5;
      --accent-bg: rgba(91,156,245,0.08);
      --green:     #4ade80;
      --green-bg:  rgba(74,222,128,0.08);
      --amber:     #f59e0b;
      --amber-bg:  rgba(245,158,11,0.08);
      --red:       #f87171;
      --red-bg:    rgba(248,113,113,0.08);
      --mono:      'JetBrains Mono', monospace;
      --sans:      'DM Sans', system-ui, sans-serif;
      --radius:    8px;
    }

    body { font-family: var(--sans); background: var(--bg); color: var(--text); line-height: 1.55; min-height: 100vh; }

    .app { max-width: 1440px; margin: 0 auto; padding: 2rem 2rem 4rem; }

    header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    header .icon { width: 40px; height: 40px; background: var(--accent-bg); border: 1px solid rgba(91,156,245,0.2); border-radius: 10px; display: grid; place-items: center; font-size: 1.2rem; }
    header h1 { font-size: 1.25rem; font-weight: 600; letter-spacing: -0.01em; }
    header p { color: var(--text-dim); font-size: 0.85rem; margin-top: 2px; }

    .controls { display: flex; gap: 1rem; align-items: stretch; flex-wrap: wrap; margin-top: 1rem; margin-bottom: 1.5rem; }
    .control-group { display: flex; flex-direction: column; gap: 6px; }
    .control-group label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-dim); }

    .dropzone { flex: 1; min-width: 280px; border: 2px dashed var(--border); border-radius: var(--radius); background: var(--surface); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; transition: border-color 0.2s, background 0.2s; position: relative; }
    .dropzone:hover, .dropzone.dragover { border-color: var(--accent); background: var(--accent-bg); }
    .dropzone.has-file { border-style: solid; border-color: var(--green); background: var(--green-bg); }
    .dropzone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .dropzone .dz-icon { font-size: 1.4rem; }
    .dropzone .dz-text { font-size: 0.9rem; color: var(--text-dim); }
    .dropzone.has-file .dz-text { color: var(--green); }

    .info-box { font-family: var(--mono); font-size: 0.85rem; background: var(--accent-bg); color: var(--accent); border: 1px solid rgba(91,156,245,0.2); border-radius: var(--radius); padding: 0.6rem 1rem; min-width: 120px; display: flex; align-items: center; }
    .info-box.empty { color: var(--text-dim); background: var(--surface); border-color: var(--border); }

    .status-bar { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: var(--radius); font-size: 0.85rem; margin-bottom: 0.5rem; }
    .status-bar.loading { background: var(--amber-bg); color: var(--amber); }
    .status-bar.ready   { background: var(--green-bg); color: var(--green); }
    .status-bar.error   { background: var(--red-bg); color: var(--red); }
    .spinner { width: 14px; height: 14px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; white-space: nowrap; }
    thead th { position: sticky; top: 0; background: var(--surface2); font-weight: 600; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); padding: 0.7rem 0.75rem; border-bottom: 1px solid var(--border); text-align: left; }
    tbody td { padding: 0.55rem 0.75rem; border-bottom: 1px solid var(--border); font-family: var(--mono); font-size: 0.78rem; }
    tbody tr:hover { background: rgba(91,156,245,0.03); }
    tbody tr:last-child td { border-bottom: none; }
    .smiles-cell { max-width: 220px; overflow: hidden; text-overflow: ellipsis; cursor: help; }

    .salt-select { font-family: var(--sans); font-size: 0.78rem; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 0.3rem 0.5rem; outline: none; cursor: pointer; }
    .salt-select:focus { border-color: var(--accent); }
    .mw-shipped { color: var(--accent); }
    .mw-na      { color: var(--text-dim); font-style: italic; }

    .stock-cell { text-align: center; font-size: 0.95rem; }
    .stock-yes  { color: var(--green); font-weight: 700; }
    .stock-no   { color: var(--red); font-weight: 700; }
    .stock-pending { opacity: 0.5; }

    .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-family: var(--sans); font-size: 0.72rem; font-weight: 600; }
    .badge-solution { background: rgba(91,156,245,0.12); color: var(--accent); }
    .badge-solid    { background: rgba(245,158,11,0.12); color: var(--amber); }

    .row-duplicate { background: rgba(248,113,113,0.06); }
    .row-duplicate td { opacity: 0.45; text-decoration: line-through; }
    .row-duplicate .dupe-tag { opacity: 1; text-decoration: none; font-size: 1.1rem; }
    .row-not-in-stock { background: rgba(248,113,113,0.04); }

    .actions { display: flex; gap: 0.75rem; margin-top: 1.25rem; flex-wrap: wrap; }
    .btn { font-family: var(--sans); font-size: 0.85rem; font-weight: 600; padding: 0.65rem 1.5rem; border-radius: var(--radius); border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.15s, transform 0.1s; }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-primary   { background: var(--accent); color: #fff; }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-warning   { background: var(--amber); color: #000; }
    .btn-danger    { background: var(--red); color: #fff; }
    .btn-primary:hover:not(:disabled) { opacity: 0.85; }
    .btn-secondary:hover:not(:disabled) { border-color: var(--text-dim); }
    .btn-warning:hover:not(:disabled) { opacity: 0.85; }
    .btn-danger:hover:not(:disabled) { opacity: 0.85; }

    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--green); color: #000; font-weight: 600; font-size: 0.85rem; padding: 0.65rem 1.5rem; border-radius: var(--radius); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; pointer-events: none; z-index: 100; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .row-count { color: var(--text-dim); font-size: 0.8rem; margin-top: 0.75rem; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="icon">âš—ï¸</div>
    <div>
      <h1>Submission Template Converter</h1>
      <p>Convert candidate TSV exports into the crystallography submission format</p>
    </div>
  </header>

  <div id="rdkitStatus" class="status-bar loading">
    <div class="spinner"></div><span>Loading RDKit molecular engineâ€¦</span>
  </div>
  <div id="stockSolutionStatus" class="status-bar loading">
    <div class="spinner"></div><span>Waiting for RDKit to load Solution stockâ€¦</span>
  </div>
  <div id="stockSolidStatus" class="status-bar loading">
    <div class="spinner"></div><span>Waiting for RDKit to load Solid stockâ€¦</span>
  </div>

  <div class="controls">
    <div class="control-group" style="flex:1; min-width:280px;">
      <label>TSV File</label>
      <div class="dropzone" id="dropzone">
        <span class="dz-icon">ğŸ“„</span>
        <span class="dz-text" id="dzText">Drop TSV file here or click to browse</span>
        <input type="file" id="fileInput" accept=".tsv,.txt,.csv">
      </div>
    </div>
    <div class="control-group">
      <label>Target (auto-detected)</label>
      <div class="info-box empty" id="targetDisplay">â€”</div>
    </div>
  </div>

  <div id="previewSection" class="hidden">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th></th>
            <th>In Soln</th>
            <th>In Solid</th>
            <th>Source</th>
            <th>Target</th>
            <th>cpd ID</th>
            <th>Lot ID (SMILES)</th>
            <th>MW Free [g/mol]</th>
            <th>Salt Form</th>
            <th>MW Shipped [g/mol]</th>
            <th>Conc.</th>
            <th>Vol.</th>
            <th>Qty</th>
            <th>Solvent</th>
          </tr>
        </thead>
        <tbody id="previewBody"></tbody>
      </table>
    </div>
    <div class="row-count" id="rowCount"></div>

    <div class="actions">
      <button class="btn btn-warning" id="scanDupesBtn" disabled>ğŸ” Scan for Duplicates</button>
      <button class="btn btn-danger" id="purgeDupesBtn" disabled>ğŸ—‘ï¸ Remove ğŸ’© Duplicates</button>
      <button class="btn btn-primary" id="copyBtn" disabled>ğŸ“‹ Copy for Template</button>
      <button class="btn btn-secondary" id="exportCsvBtn" disabled>ğŸ’¾ Export CSV</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SALTS = [
    { name: "Free base",               delta: 0       },
    { name: "Hydrochloride (HCl)",      delta: 36.461  },
    { name: "Trifluoroacetate (TFA)",   delta: 114.023 },
    { name: "Acetate",                  delta: 60.052  },
    { name: "Mesylate",                 delta: 96.106  },
    { name: "Tosylate",                 delta: 172.202 },
    { name: "Maleate",                  delta: 116.072 },
    { name: "Sulfate",                  delta: 98.079  },
    { name: "Citrate",                  delta: 192.124 },
    { name: "Tartrate",                 delta: 150.087 },
    { name: "Besylate",                 delta: 158.175 },
  ];

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let RDKitModule = null;
  let parsedRows = [];
  let detectedTarget = "";
  let solutionSet = null;
  let solidSet = null;

  // â”€â”€ RDKit + Stock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rdkitScript = document.createElement("script");
  rdkitScript.src = "https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js";
  rdkitScript.onload = () => {
    window.initRDKitModule().then(mod => {
      RDKitModule = mod;
      updateStatusBar("rdkitStatus", "ready", "âœ“ RDKit ready");
      loadStockFiles();
      if (parsedRows.length > 0) recalcAllMW();
    });
  };
  document.head.appendChild(rdkitScript);

  function loadStockFiles() {
    [
      { file: "wuxi_ots_stock_canonical.txt",  label: "Solution", id: "stockSolutionStatus", set: s => solutionSet = s },
      { file: "wuxi_ots_solid_canonical.txt",   label: "Solid",    id: "stockSolidStatus",    set: s => solidSet = s },
    ].forEach(({ file, label, id, set: setter }) => {
      updateStatusBar(id, "loading", `Loading ${label} stockâ€¦`);
      fetch(file)
        .then(r => { if (!r.ok) throw new Error(); return r.text(); })
        .then(text => {
          const s = new Set(text.trim().split("\n"));
          setter(s);
          updateStatusBar(id, "ready", `âœ“ ${label} stock â€” ${s.size.toLocaleString()} compounds`);
          if (parsedRows.length > 0) { checkAllStock(); renderTable(); }
        })
        .catch(() => updateStatusBar(id, "error", `âœ— ${label} stock file not found`));
    });
  }

  function updateStatusBar(id, type, msg) {
    const el = document.getElementById(id);
    el.className = `status-bar ${type}`;
    el.innerHTML = type === "loading"
      ? `<div class="spinner"></div><span>${msg}</span>`
      : `<span>${msg}</span>`;
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function extractTarget(filename) {
    const match = filename.match(/_([^_]+?)-(?:selected-|20\d\d)/i);
    return match ? match[1] : "UNKNOWN";
  }

  function calcMW(smiles) {
    if (!RDKitModule) return null;
    try {
      const mol = RDKitModule.get_mol(smiles);
      if (!mol) return null;
      const mw = parseFloat(JSON.parse(mol.get_descriptors()).exactmw);
      mol.delete();
      return isNaN(mw) ? null : mw;
    } catch { return null; }
  }

  function canonicalize(smiles) {
    if (!RDKitModule) return null;
    try {
      const mol = RDKitModule.get_mol(smiles);
      if (!mol) return null;
      const c = mol.get_smiles();
      mol.delete();
      return c;
    } catch { return null; }
  }

  // â”€â”€ TSV Parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function parseTSV(text) {
    const lines = text.trim().split("\n");
    if (lines.length < 2) return [];
    const h = lines[0].split("\t").map(s => s.trim());
    const mi = h.indexOf("Molecule"), ii = h.indexOf("Id"), ci = h.indexOf("Created By");
    if (mi === -1 || ii === -1) { alert("TSV must have 'Molecule' and 'Id' columns."); return []; }

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const c = lines[i].split("\t");
      if (c.length <= Math.max(mi, ii)) continue;
      const createdBy = ci !== -1 ? c[ci].trim() : "";
      rows.push({
        smiles: c[mi].trim(),
        id: c[ii].trim(),
        source: createdBy.toLowerCase().includes("solution") ? "solution" : "solid",
        sourceRaw: createdBy,
        freeMW: null, saltIndex: 0, canonSmiles: null,
        inSolution: false, inSolid: false, isDupe: false,
      });
    }
    return rows;
  }

  // â”€â”€ MW + Stock Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function recalcAllMW() {
    parsedRows.forEach(r => {
      r.freeMW = calcMW(r.smiles);
      if (!r.canonSmiles) r.canonSmiles = canonicalize(r.smiles);
    });
    checkAllStock();
    renderTable();
  }

  function checkAllStock() {
    if (!RDKitModule) return;
    let sm = 0, sdm = 0;
    parsedRows.forEach(r => {
      if (!r.canonSmiles) r.canonSmiles = canonicalize(r.smiles);
      r.inSolution = solutionSet && r.canonSmiles ? solutionSet.has(r.canonSmiles) : false;
      r.inSolid    = solidSet    && r.canonSmiles ? solidSet.has(r.canonSmiles)    : false;
      if (r.inSolution) sm++;
      if (r.inSolid) sdm++;
    });
    if (solutionSet) updateStatusBar("stockSolutionStatus", "ready", `âœ“ Solution stock â€” ${sm}/${parsedRows.length} found`);
    if (solidSet)    updateStatusBar("stockSolidStatus",    "ready", `âœ“ Solid stock â€” ${sdm}/${parsedRows.length} found`);
  }

  // â”€â”€ Duplicate Scanning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Same canonical SMILES exists as both Solution AND Solid?
  // â†’ Tag the Solid row with ğŸ’© (keep Solution)
  function scanDuplicates() {
    if (!RDKitModule) { showToast("RDKit not ready yet"); return; }

    parsedRows.forEach(r => {
      if (!r.canonSmiles) r.canonSmiles = canonicalize(r.smiles);
      r.isDupe = false; // reset
    });

    // Build map: canonical â†’ { hasSolution, solidIndices }
    const map = new Map();
    parsedRows.forEach((r, i) => {
      if (!r.canonSmiles) return;
      if (!map.has(r.canonSmiles)) map.set(r.canonSmiles, { hasSolution: false, solidIndices: [] });
      const e = map.get(r.canonSmiles);
      if (r.source === "solution") e.hasSolution = true;
      else e.solidIndices.push(i);
    });

    let dupeCount = 0;
    map.forEach(e => {
      if (e.hasSolution && e.solidIndices.length > 0) {
        e.solidIndices.forEach(i => { parsedRows[i].isDupe = true; dupeCount++; });
      }
    });

    document.getElementById("purgeDupesBtn").disabled = dupeCount === 0;
    renderTable();
    showToast(dupeCount > 0
      ? `ğŸ’© ${dupeCount} solid duplicate${dupeCount > 1 ? "s" : ""} tagged`
      : "No duplicates â€” all clean!");
  }

  function purgeDuplicates() {
    const before = parsedRows.length;
    parsedRows = parsedRows.filter(r => !r.isDupe);
    document.getElementById("purgeDupesBtn").disabled = true;
    renderTable();
    showToast(`Purged ${before - parsedRows.length} dupes â†’ ${parsedRows.length} remaining`);
  }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const tbody = document.getElementById("previewBody");

    tbody.innerHTML = parsedRows.map((row, i) => {
      const isSol = row.source === "solution";
      const freeMW = row.freeMW !== null ? row.freeMW.toFixed(2) : "â€”";
      const salt = SALTS[row.saltIndex];
      const shipped = row.saltIndex === 0
        ? '<span class="mw-na">â€”</span>'
        : (row.freeMW !== null ? `<span class="mw-shipped">${(row.freeMW + salt.delta).toFixed(2)}</span>` : "â€”");

      const solIcon = !solutionSet ? 'â³' : row.inSolution ? '<span class="stock-yes">âœ“</span>' : '<span class="stock-no">âœ—</span>';
      const sldIcon = !solidSet    ? 'â³' : row.inSolid    ? '<span class="stock-yes">âœ“</span>' : '<span class="stock-no">âœ—</span>';
      const notInEither = (solutionSet && !row.inSolution) && (solidSet && !row.inSolid);

      const saltOpts = SALTS.map((s, si) =>
        `<option value="${si}" ${si === row.saltIndex ? "selected" : ""}>${s.name}</option>`
      ).join("");

      const badge = isSol
        ? '<span class="badge badge-solution">Solution</span>'
        : '<span class="badge badge-solid">Solid</span>';

      let cls = "";
      if (row.isDupe) cls = "row-duplicate";
      else if (notInEither) cls = "row-not-in-stock";

      return `<tr class="${cls}">
        <td style="color:var(--text-dim)">${i + 1}</td>
        <td class="dupe-tag">${row.isDupe ? "ğŸ’©" : ""}</td>
        <td class="stock-cell">${solIcon}</td>
        <td class="stock-cell">${sldIcon}</td>
        <td>${badge}</td>
        <td>${detectedTarget}</td>
        <td>${row.id}</td>
        <td class="smiles-cell" title="${row.smiles}">${row.smiles}</td>
        <td>${freeMW}</td>
        <td><select class="salt-select" data-row="${i}" onchange="onSaltChange(this)">${saltOpts}</select></td>
        <td>${shipped}</td>
        <td>${isSol ? "10 mM" : ""}</td>
        <td>${isSol ? "50" : ""}</td>
        <td>${isSol ? "" : "2"}</td>
        <td>DMSO</td>
      </tr>`;
    }).join("");

    const active = parsedRows.filter(r => !r.isDupe).length;
    const dupes  = parsedRows.filter(r =>  r.isDupe).length;
    let t = `${parsedRows.length} compounds`;
    if (dupes > 0) t += ` Â· ğŸ’© ${dupes} tagged Â· ${active} clean`;
    document.getElementById("rowCount").textContent = t;

    document.getElementById("copyBtn").disabled = false;
    document.getElementById("exportCsvBtn").disabled = false;
    document.getElementById("scanDupesBtn").disabled = false;
  }

  function onSaltChange(el) {
    parsedRows[parseInt(el.dataset.row)].saltIndex = parseInt(el.value);
    renderTable();
  }

  // â”€â”€ Clipboard (clean rows only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function copyToClipboard() {
    const clean = parsedRows.filter(r => !r.isDupe);
    const lines = clean.map(row => {
      const isSol = row.source === "solution";
      const salt = SALTS[row.saltIndex];
      const fm = row.freeMW !== null ? row.freeMW.toFixed(2) : "";
      const sm = row.saltIndex === 0 ? "" : (row.freeMW !== null ? (row.freeMW + salt.delta).toFixed(2) : "");
      return [
        detectedTarget, row.id, "",
        isSol ? "WuXi OTS Solution" : "WuXi OTS Solid",
        row.smiles, "", fm, sm,
        isSol ? "" : "2",
        isSol ? "10 mM" : "",
        isSol ? "50" : "",
        "DMSO",
      ].join("\t");
    });
    navigator.clipboard.writeText(lines.join("\n"))
      .then(() => showToast(`${clean.length} rows copied (dupes excluded)`));
  }

  // â”€â”€ CSV Export (clean rows only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function exportCSV() {
    const headers = [
      "Target","cpd ID","crelux code","supplier","lot ID",
      "container ID","molecular weight of free compound [g/mol]",
      "molecular weight of shipped isoform [g/mol]","quantity [mg]",
      "concentration [mM]","volume [Âµl]","recommended solvent",
      "Original plate name","plate position","comment",
      "salt adduct?","bundle #","priority",
      "number of structures ordered per bundle"
    ];
    const esc = v => { const s = String(v); return /[",\n\r]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s; };

    const clean = parsedRows.filter(r => !r.isDupe);
    const csvRows = [headers.map(esc).join(",")];
    clean.forEach(row => {
      const isSol = row.source === "solution";
      const salt = SALTS[row.saltIndex];
      const fm = row.freeMW !== null ? row.freeMW.toFixed(2) : "";
      const sm = row.saltIndex === 0 ? "" : (row.freeMW !== null ? (row.freeMW + salt.delta).toFixed(2) : "");
      csvRows.push([
        detectedTarget, row.id, "",
        isSol ? "WuXi OTS Solution" : "WuXi OTS Solid",
        row.smiles, "", fm, sm,
        isSol ? "" : "2",
        isSol ? "10 mM" : "",
        isSol ? "50" : "",
        "DMSO", "", "", "", "", "", "", ""
      ].map(esc).join(","));
    });

    const blob = new Blob([csvRows.join("\n")], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${detectedTarget}_submission.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast(`CSV exported â€” ${clean.length} compounds`);
  }

  // â”€â”€ File Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleFile(file) {
    if (!file) return;
    document.getElementById("dzText").textContent = file.name;
    document.getElementById("dropzone").classList.add("has-file");

    detectedTarget = extractTarget(file.name);
    const te = document.getElementById("targetDisplay");
    te.textContent = detectedTarget;
    te.classList.toggle("empty", detectedTarget === "UNKNOWN");

    document.getElementById("purgeDupesBtn").disabled = true;

    const reader = new FileReader();
    reader.onload = e => {
      parsedRows = parseTSV(e.target.result);
      if (!parsedRows.length) return;
      if (RDKitModule) recalcAllMW(); else renderTable();
      document.getElementById("previewSection").classList.remove("hidden");
    };
    reader.readAsText(file);
  }

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2500);
  }

  // â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("fileInput").addEventListener("change", e => handleFile(e.target.files[0]));
  const dz = document.getElementById("dropzone");
  dz.addEventListener("dragover", e => { e.preventDefault(); dz.classList.add("dragover"); });
  dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
  dz.addEventListener("drop", e => { e.preventDefault(); dz.classList.remove("dragover"); handleFile(e.dataTransfer.files[0]); });

  document.getElementById("scanDupesBtn").addEventListener("click", scanDuplicates);
  document.getElementById("purgeDupesBtn").addEventListener("click", purgeDuplicates);
  document.getElementById("copyBtn").addEventListener("click", copyToClipboard);
  document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);
</script>

</body>
</html>
